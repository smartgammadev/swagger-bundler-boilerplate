
# README #
                   
Troops API
  
### Requirements ###

* Docker

## Installing ##

```bash
make vendor
make up
make publish
``` 


If the swagger repo was modified, then run:

```bash
make publish
``` 

to recompile API docs

- API doc is available on http://localhost:8084

### Init git hook 

- Init pre-commit hook (This allow you not forget publish bundled swagger spec)

```bash
git config core.hooksPath .githooks # Supported for git client > v2.9
```

### Full flow ####

`make publish`

will compile the spec file and validate it, run this every time you updated the spec

### Description ###


In `index.yaml` you may find raw version of documentation. It uses references to other files. In order to use this documentation with Swagger you have to compile those assets first(HOWTO: see section above) 

*Note*: Do not edit index_bundled.yaml file, it is autogenerated from index.yaml files from different folders (npm run concat)
 
### Local swagger UI with Docker

`make publish`

Published spec is available on http://localhost:8084 

### Troops deployed swagger UI 

master branch: https://openapi.troops.online/

feature branches: If you are working with feature-12345, then the swagger spec will be available at https://openapi-12345.troops.online/ 

### Mock backend with Prism ####

#### Install non docker users

`npm install -g @stoplight/prism-cli` 

#### Prism start for non docker users

`make mock`

#### Prism start for docker users

Will be auto-started with make up command

#### Prism usage

will emulate backed at: http://localhost:4010

Test mock server is up:

- login:

` curl "http://localhost:4010/api/login_check" -H "accept: application/json" -H "Content-Type: application/json" -d "{\"_username\":\"c.carlos.troops.online\",\"_password\":\"c.carlos.troops.online\"}" -vvv` 

should return a token:

`{"refresh_token":"Owner's refresh token","token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpYXQiOjE1NTg5ODA0NTMsImV4cCI6MTU1ODk4NDA1Mywicm9sZXMiOlsiUk9MRV9FTVBMT1lFRSIsIlJPTEVfTUFOQUdFUiIsIlJPTEVfRFJIIiwiUk9MRV9BRE1JTiIsIlJPTEVfT1dORVIiLCJST0xFX1VTRVIiXSwidXNlcm5hbWUiOiJvd25lcjBAaXp1bWEubG9jIn0.SxacLn33JBZG7cWO6QWRWhrIZOPv4CZE3DoTOPvnrlOxnORMxxFFazFYT6_4fWxkqRVBoiaAgDSgAvnjJqHCEYePKLSBozbeZQ5meP7bP8Jc5dGAPeKEEdoiW7J2biVutT1wEeOLoHmfFtCC5sLbCqrxWMj1T0utJFsAquUWu1qKScbPIb8_1yWPZSGubqLhh_LnFMWtldkzoIsNXf0YN7m9oezsNHvXZIqJ9VpuuXgHCz0Kj7Qgg78_7dvAL-U4AGeTHuxc8goZSEtXJD-Q8m2lAt7VBQ_BG5H7mWX2ktEkgqdWAGu2_rp54QaXS0h9XmgGTZfkgahtNI3w2csH3Nf-VHtbNBEdwxCIcXFxXaJjz6bTfGsyxl2PRJbitg6Wy_BbCBlHwjWOuz1q1yVxphG-2pBGSAA9CmLhDSFjKUnwaVW3UyqsstIu_OmgGf2_dfSonzIu1BnAN4GJzwXsDJQ26qMmtC6IUuMpDGuP0carCD8CRUy7gc6yIcBWk2vn1dOEr1u9mEhK_kYK72Vn3FmIAk8IUGIZy-SATApgWPVQvdtX0SBOCN4IEvZi8LxHKQnWQ6U9MCmmBqjaCCYOkxiY24pywquCnVpnbL1FK7VxNM_dKOOc3f-7XYP-Jach1d-il5Ev14YCsJgEo1D8j3EI5VV0rMl_-LLBZOhKaa0"}`

- call authorized API endpoints: 

`curl 'http://localhost:4010/api/v2/tea/teas' -H 'Content-Type: application/json' -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpYXQiOjE1Njk5NDM0NDgsImV4cCI6MTU2OTk0NzA0OCwicm9sZXMiOlsiUk9MRV9VU0VSIl0sInVzZXJuYW1lIjoiaW50ZXJpbV9kaXJlY3RvcjBAdHJvb3BzLm9ubGluZSIsImxvY2FsZSI6ImZyIn0.aKmM-0IaPmUDXsq3CTRFyrqWbMKbg-hjdbIt9h2aTlMp618zN5E9yZldo0kW10WCH13PPUG_N1Kq7fWN0EQ53cGUEA4GccpQF_DNF6jZz0dZDvPtdm93JSBKVuCOOhBC2YLdr8xRd7DG4HSz8mtu_uzQ83svRegF8wuxm69aaV-Rx03rDSdjyObno3v_wCjfFeGVhMroNFNvBwpvToyIkvLEpPbK3ea7Yk5kXaH85dExyctbxp4FhHzvtDvF331hP8iY0eOl7zR6U6e5cJ0tJyIwRPmRoyQdlaXluPJDMgo0rEI2wnYNVMtLJEmlrFJkhASV1eIniNjaqf21eHxbXREETwdYyXhjj45C4o4phIdpzRiPR8mevKXBx50BMhTt34xXSUybP_9DJJjGSjZVcId62sf3AEeWDIcWxtNmgCA1oNQuqJPKc8QHxcD2FPOMZ-4Ouds9-af2pHuqUuMLmvj-Iu36mwjmFQqc4CWx3tM3ZQ0Y33l2wlrDDQX-vO1Fjb7pOOShUoyEZvQJ2LN0Pb-S5Mm6v1cMJxwhLQ9eA44N7F8xd9CrrgtkPkv3Jb9xkHdAlz1m3N3dKYW6TemVhWrdz1R9KILzuYHiuyN5CB-mhbJFwuPmvXzLXxgxmmNvqVPWcg6QOsvWvy8yp_-XePpOUv6mNwJHTADrQEKpB-U' -vvv`

should response with:

`{"data":[{"id":1,"title":"Idumo","siren":"794058537","siret":"79405853743512","address":{"city":"Lyon","zip_code":"69002","address":"63 Rue de la RÃ©publique","country_id":1,"latitude":45.7596796,"longitude":45.7596796},"nic":"43512","is_main":true}],"pagination":{"total":30,"current_page":1,"per_page":10,"total_pages":3}}`

- test validation case: 

`curl -X PUT "http://localhost:4010/api/v2/candidate/hourly-rate" -H "accept: application/json" -H "Authorization: Bearer xxxxx" -H "Content-Type: application/json" -d "{}" -vvv`

Should reply with response code: 400

- test "happy path" case for the same API: 

`curl -X PUT "http://localhost:4010/api/v2/candidate/hourly-rate" -H "accept: application/json" -H "Authorization: Bearer xxxxx" -H "Content-Type: application/json" -d "{\"hourly_rate\": 10}"`

Should reply with response code: 200 and response body:

`{"id":1,"hourly_rate":10}`

#### Prism usage from Swagegr UI

- open swagger  UI locally: http://localhost:8084
- change target server to "http://localhost:4010" and "Autorize" http://i.imgur.com/c4o8raJ.png
- put any string to Token field and "Authorize": http://i.imgur.com/Sva44ns.png 
- go to your API and use "Try it out" - it will get a response from your Prism mock server http://i.imgur.com/1qCm1lp.png

#### Prism logs

- Non-docker users will see the logs in the window `make mock` is runned
- Docker users can watch it with `make mock-logs`

### Usefull links:

- Convert Json Response to Yaml Swagger
https://bikcrum.github.io/Swagger-JSON-Schema-In-YAML_webversion/

- Convert Json to Yaml with examples from the response
https://swagger-toolbox.firebaseapp.com/
